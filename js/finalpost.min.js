var tocId = "#toc";
var flagId = "#tocFlag";
var post = {
    appreciateModel: function () {
        $(".appreciate-btn").on("click", function (e) {
            $(".qr-code-wrap").velocity("transition.expandIn", {
                duration: 300
            });
            $(document).one("click", function () {
                $(".qr-code-wrap").velocity("transition.expandOut", {
                    duration: 300
                })
            });
            e.stopPropagation()
        })
    },
    toggleSocialShare: function () {
        $(".share-btn").on("click", function (e) {
            var icons = $("#socialShare");
            if (icons.hasClass("show")) {
                $("#socialShare").velocity("transition.slideUpOut", {
                    duration: 300
                })
            } else {
                $("#socialShare").velocity("transition.slideDownIn", {
                    duration: 300
                })
            }
            icons.toggleClass("show")
        })
    },
    appreciate: function () {
        $(".qr-code").on("click", function (e) {
            e.stopPropagation()
        });
        $(".closinglayer").on("click", function (e) {
            $(".qr-code-wrap").velocity("transition.expandOut", {
                duration: 300
            })
        });
        $(".zfb-btn").on("click", function (e) {
            $(".qr_code_zfb").css("height", "300px");
            $(".qr_code_wx").css("height", "0")
        });
        $(".wx-btn").on("click", function (e) {
            $(".qr_code_wx").css("height", "300px");
            $(".qr_code_zfb").css("height", "0")
        })
    },
    removeFirstUL: function () {
        var post_content = document.getElementById("post-content");
        if (!post_content) {
            return
        }
        var firstNodeName = post_content.firstElementChild.nodeName;
        if (firstNodeName === "UL") {
            $(post_content.firstElementChild).hide()
        }
    },
    getScrollTop: function () {
        return document.documentElement.scrollTop || document.body.scrollTop
    },
    tocScroll: function (event) {
        var Obj = $(flagId);
            if (1 !== Obj.length) return !1;
            var tocFixed = $(tocId),
                ObjTop = Obj.offset().top - .5 * $(window).height(),
                scrollTop = post.getScrollTop(),
                postHeaderHeight;
            scrollTop > $("#postHeader").height() ? tocFixed.show() : tocFixed.hide();
            var tocEle = document.querySelector(tocId),
                tocHeight;
            tocEle && tocEle.getBoundingClientRect() && (scrollTop > ObjTop - .5 * tocEle.getBoundingClientRect().height ? tocFixed.addClass("right-fixed") : tocFixed.removeClass("right-fixed"), post.tocParentActive(), event.preventDefault())
    },
    scrollTocFixed: function () {
        window.addEventListener("scroll", post.tocScroll, false)
    },
    initToc: function () {
        var headerEl = "h1,h2,h3,h4,h5,h6",
            content = ".post-content";
        tocbot.init({
            tocSelector: "#toc",
            contentSelector: content,
            headingSelector: headerEl,
            scrollSmooth: !0,
            headingsOffset: 0 - $("#postHeader").height() + $("#siteHeader").height(),
            hasInnerContainers: !1,
            scrollSmoothOffset: -$("#siteHeader").height()
        });
        $(".toc-link").each((function () {
            var linkContent = $(this).html();
            $(this).html('<span class="toc-link-dot"></span>' + linkContent)
        })), 
        post.tocEleRight()
    },
    tocEleRight: function () {
        var screenWidth = document.body.clientWidth,
            tocEle = document.getElementById("toc");
        tocEle && (tocEle.style.left = (screenWidth - 800) / 2 + 850 + "px")
    },
    readProgress: function () {
        var $content = $("#main");
        var $readProgressBar = $("#readProgress .read-progress-bar");
        var changeReadProgress = function () {
            var contentHeight = $content.height() - window.innerHeight;
            if (contentHeight <= 0) return;
            var readHeight = window.pageYOffset - $content.offset().top;
            var progressWidth = readHeight / contentHeight * 100 + "%";
            $readProgressBar.width(progressWidth)
        };
        displayReadProgress && changeReadProgress();
        $(window).on("scroll", function () {
            displayReadProgress && changeReadProgress()
        })
    },
    initViewer: function () {
        if (document.getElementById("post-content")) {
            new Viewer(document.getElementById("post-content"), {
                toolbar: false
            })
        }
    },
    loadHighlight: function () {
        var codes = document.querySelectorAll(".post-page pre code");
        for (var i = 0; i < codes.length; i++) {
            var block = codes[i];
            hljs.highlightBlock(block);
            $("code.hljs").each(function (i, block) {
                hljs.lineNumbersBlock(block)
            })
        }
    },
    tocHover: function () {
        $(".toc-list-item span").hover(function () {
            $(this).parent().find("a.toc-link:first").addClass("toc-hover")
        }, function () {
            $(this).parent().find("a.toc-link:first").removeClass("toc-hover")
        })
    },
    tocParentActive: function () {
        var isCollapsible = $(".is-active-li").parents("ol.toc-list.is-collapsible");
        if (isCollapsible) {
            isCollapsible.each(function () {
                $(this).parent().find("a.toc-link:first").addClass("toc-hover")
            })
        }
        var isCollapsed = $("ol.toc-list.is-collapsible.is-collapsed");
        if (isCollapsed) {
            isCollapsed.each(function () {
                $(this).parent().find("a.toc-link:first").removeClass("toc-hover")
            })
        }
    },
    shareIcon: function () {
        var $config = {
            sites: ["google", "twitter", "facebook", "weibo", "qq", "tencent", "qzone", "linkedin", "wechat", "douban", "diandian"],
            disabled: socialDisabled.split(",")
        };
        socialShare(".social-share", $config)
    }
};
$(function () {
    post.appreciate();
    post.initToc();
    post.removeFirstUL();
    post.scrollTocFixed();
    post.readProgress();
    post.loadHighlight();
    post.appreciateModel();
    post.toggleSocialShare();
    post.initViewer();
    post.tocHover()
});